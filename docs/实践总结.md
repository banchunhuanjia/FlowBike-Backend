
### èƒ½è·‘ â†’ ç†è§£ â†’ å¾®æ”¹ â†’ æ‰©å±• â†’ ä¼˜åŒ– â†’ é‡æ„

å½“ä½ é‡åˆ°é—®é¢˜çš„æ—¶å€™ï¼š

âŒ ä¸è¦ä¸€æ¥å°±è¯´ï¼šå¸®æˆ‘å†™æ€ä¹ˆåš
âŒ ä¸è¦åªè´´æŠ¥é”™æˆªå›¾
âŒ ä¸è¦æŠŠæŒ‡æœ›æ”¾åœ¨æˆ‘â€œä¿®ä»£ç â€

æ­£ç¡®æ–¹å¼ï¼š

âœ” å‘Šè¯‰æˆ‘ä½ æƒ³å®ç°ä»€ä¹ˆ
âœ” ç»™å‡ºä½ å°è¯•è¿‡çš„æ€è·¯
âœ” æä¾›ç›¸å…³ä»£ç ç‰‡æ®µ
âœ” è¯´æ˜ä½ è§‚å¯Ÿåˆ°çš„ç°è±¡ / é¢„æœŸè¡Œä¸º

è¿™æ ·ä¸€æ¥ï¼š

æˆ‘èƒ½çœ‹å‡ºä½ çš„æ€è€ƒè¿‡ç¨‹

ä½ èƒ½å­¦åˆ°æ›´å¤š

è¿™ä¸ªé¡¹ç›®æ‰çœŸæ­£å±äºä½ 


**1.å‡½æ•°è¿”å›å¼•ç”¨æ³•åˆ™**

  ç›´æ¥æŒ‰å€¼è¿”å› std::stringï¼Œè®©ç¼–è¯‘å™¨å»ä¼˜åŒ–ã€‚å®‰å…¨æ°¸è¿œæ˜¯ç¬¬ä¸€ä½çš„
ä¸è¿‡æˆ‘ä»¬è¿˜æ˜¯ç»™ä¸€ä¸ªåˆ¤æ–­æµç¨‹

- é—®é¢˜ 1ï¼šæˆ‘è¦è¿”å›çš„ä¸œè¥¿ï¼Œæ˜¯ä¸æ˜¯å‡½æ•°çš„å‚æ•°ä¹‹ä¸€ï¼Ÿ
  - æ˜¯ï¼š âœ… éå¸¸å®‰å…¨ï¼è¿™æ˜¯è¿”å›å¼•ç”¨çš„æœ€å¸¸è§ã€æœ€å®‰å…¨çš„ç”¨æ³•ã€‚
  - å¦ï¼š ğŸ”´ å±é™©ï¼è¯·ç»§ç»­é—®ä¸‹ä¸€ä¸ªé—®é¢˜
- é—®é¢˜ 2ï¼šæˆ‘è¦è¿”å›çš„ä¸œè¥¿ï¼Œæ˜¯ä¸æ˜¯ä¸€ä¸ªç±»çš„æˆå‘˜å˜é‡ï¼Ÿ
  - æ˜¯ï¼š ğŸŸ¡ å¯èƒ½æ˜¯å®‰å…¨çš„ï¼Œä½†æœ‰é£é™©ã€‚è¯·ç»§ç»­é—®æœ€å…³é”®çš„ç¬¬ 3 ä¸ªé—®é¢˜ã€‚
  - å¦ï¼š âŒ ç»å¯¹ç¦æ­¢ï¼ å¦‚æœä¸€ä¸ªä¸œè¥¿æ—¢ä¸æ˜¯å‡½æ•°å‚æ•°ï¼Œä¹Ÿä¸æ˜¯ç±»çš„æˆå‘˜å˜é‡ï¼Œé‚£å®ƒå¿…ç„¶æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ã€‚è¿”å›å±€éƒ¨å˜é‡çš„å¼•ç”¨æ˜¯ C++ çš„**â€œé‡ç½ªâ€**ï¼Œä¼šå¯¼è‡´ç¨‹åºç«‹å³å´©æºƒæˆ–äº§ç”Ÿæœªå®šä¹‰è¡Œä¸ºã€‚
- é—®é¢˜ 3 (æœ€å…³é”®ï¼)ï¼šæ‹¿åˆ°è¿™ä¸ªè¿”å›å¼•ç”¨çš„ä»£ç ï¼Œèƒ½ä¸èƒ½æ¯”æ‹¥æœ‰è¿™ä¸ªæ•°æ®çš„å¯¹è±¡æ´»å¾—æ›´ä¹…ï¼Ÿ
è¿™ä¸ªé—®é¢˜ä¸“é—¨é’ˆå¯¹â€œè¿”å›ç±»æˆå‘˜å˜é‡çš„å¼•ç”¨â€çš„æƒ…å†µã€‚
  - èƒ½ï¼š âŒ ç»å¯¹ç¦æ­¢ï¼ è¿™å°±æ˜¯â€œæ‚¬å‚å¼•ç”¨â€çš„æ ¹æºã€‚
  - ä¸èƒ½ (å³ï¼Œå¯¹è±¡ä¿è¯æ¯”å¼•ç”¨æ´»å¾—é•¿)ï¼š âœ… ç›¸å¯¹å®‰å…¨ã€‚è¿™æ„å‘³ç€å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå®Œå…¨ç”±ä½ æŒæ§ï¼Œå¹¶ä¸”ä½ çŸ¥é“å®ƒåœ¨æ•´ä¸ªå¼•ç”¨ä½¿ç”¨æœŸé—´éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚

---
**2.optionalçš„ä½¿ç”¨**
```c++
auto desc_opt = ErrorManager::getInstance().getDesc(999);
if (desc_opt.has_value()) {
    // æ‰¾åˆ°äº†
    std::cout << "Error description: " << desc_opt.value() << std::endl;
} else {
    // æ²¡æ‰¾åˆ°
    std::cout << "Error code 999 not found!" << std::endl;
}
```

---
**3.å‘å‰å£°æ˜çš„ä½¿ç”¨æ³•åˆ™**

åœ¨ .h æ–‡ä»¶ä¸­ï¼Œå¦‚æœä½ åªéœ€è¦ä½¿ç”¨ä¸€ä¸ªç±»çš„æŒ‡é’ˆ (*) æˆ–å¼•ç”¨ (&)ï¼Œå°±ä¼˜å…ˆä½¿ç”¨å‰å‘å£°æ˜ï¼Œè€Œä¸æ˜¯ #includeã€‚

---
**4.è®©æŠ½è±¡ç±»æ›´çº¯ç²¹**

æ°¸è¿œä¸èƒ½åˆ›å»ºå®ä¾‹
```c++
protected:
  iEventHandler() = default;
```

---
**5.ç±»å‹è½¬æ¢æ³•åˆ™**

å­è½¬çˆ¶static_cast
çˆ¶è½¬å­dynamic_cast

---
**6.gdb+coredumpæ€ç»´æµç¨‹**
```bash
0  0x00007f314a772078 in ___pthread_mutex_lock (
    mutex=0x7f314a77e66b <_int_malloc+3259>)
    at ./nptl/pthread_mutex_lock.c:136
1  0x000055bad5ae2963 in __gthread_mutex_lock (
    __mutex=0x7f314a77e66b <_int_malloc+3259>)
    at /usr/include/x86_64-linux-gnu/c++/11/bits/gthr-default.h:749
2  0x000055bad5ae2bea in std::mutex::lock (
    this=0x7f314a77e66b <_int_malloc+3259>)
    at /usr/include/c++/11/bits/std_mutex.h:100
3  0x000055bad5ae39ca in std::lock_guard<std::mutex>::lock_guard (
    this=0x7ffe86bb1830, __m=...)
    at /usr/include/c++/11/bits/std_mutex.h:229
4  0x000055bad5adf8d4 in DispatchMsgService::unsubscribe (
    this=0x7f314a77e62b <_int_malloc+3195>, eid=1)

    at /home/linyuan/FlowBike/src/dispatchmsgservice.cpp:26
5  0x000055bad5aebabb in UserEventHandler::~UserEventHandler (this=0x7ffe86bb1950, __in_chrg=<optimized out>) at /home/linyuan/FlowBike/src/usereventhandler.cpp:22
6  0x000055bad5ad9277 in main () at /home/linyuan/FlowBike/src/main.cpp:38
```
å¯¹ç…§å„ç§æ–‡ä»¶æ¥çœ‹
- 0å¸§ï¼šé”™è¯¯åœ¨pthread_mutex_lock -> ä¸mutexçŠ¶æ€æœ‰å…³
- 1ï¼Œ2ï¼Œ3å¸§å®šä½æ˜¯lock_guardä½¿ç”¨é”
- 4å¸§å‘Šè¯‰æˆ‘ä»¬æ˜¯é€€è®¢é˜…çš„æ—¶å€™å‡ºé”™ï¼Œæ‰€ä»¥è¿™ä¸ªé”æ˜¯dmsçš„ï¼Œæ‰€ä»¥æ˜¯dmså®ä¾‹å‡ºäº†é—®é¢˜
- 5å¸§å‘Šè¯‰æˆ‘ä»¬æ˜¯usereventhandlerçš„ææ„ä¸­è°ƒç”¨é€€è®¢é˜…å‡ºé—®é¢˜ï¼Œæ‰€ä»¥æ˜¯uehçš„dms_å‡ºäº†é—®é¢˜
- æ— æ•ˆåŸå› ï¼š
  - æ›¾æœ‰æ•ˆï¼Œä½†æ˜¯åé¢åäº† ->æ ¹æ®ä¸»å‡½æ•°æ‰§è¡Œç»“æœå‘ç°ææ„é¡ºåºæ²¡é—®é¢˜
  - ä¸€å¼€å§‹å°±æ— æ•ˆ ->æ£€æŸ¥æ„é€ å‡½æ•°ï¼Œå‘ç°çœŸçš„æ˜¯å¿˜æ„é€ äº†

---
**7.å­—èŠ‚åºè½¬æ¢å‡½æ•°å®¶æ—**

[h | n] to [s | l]
h: host n:network
s: short å¸¸ç”¨äºç«¯å£å·port
l: long å¸¸ç”¨äºipv4åœ°å€ï¼Œä¼ è¾“åè®®çš„åŒ…é•¿å’Œç±»å‹ID

---
**8.ç¨‹åºé€»è¾‘**

å› ä¸ºåœ¨startå‡½æ•°åˆå§‹åŒ–listener_æ—¶æˆ‘ä»¬ä¼ å…¥äº†ç¬¬ä¸€æ£’çš„èº«ä»½æŒ‡é’ˆæ˜¯NetworkInterfaceçš„thisæŒ‡é’ˆï¼Œè€Œåœ¨TcpConnection
listeneræ˜¯å·¥å‚ï¼Œbuffereventçš„äº§å“ä¸Šä¸‹æ–‡å°±æ˜¯tcp
```bash
[main]
  |
  v
[new NetworkInterface(dms)] -> this_net_if
  |
  v
[start(8080)]
  |
  v
evconnlistener_new_bind(..., static_accept_cb, this_net_if)
  |
  +-------------------------------------------------------------+
  | (libevent is now holding this_net_if for the listener)      |
  +-------------------------------------------------------------+
  |
  | [A new client connects...]
  |
  v
[libevent calls static_accept_cb(..., void* ctx)]  <-- ctx IS this_net_if
  |
  v
[self = static_cast<NetworkInterface*>(ctx)]
  |
  v
[self->accept_new_connection(...)]
  |
  v
[new TcpConnection(..., self, ...)] -> new_conn
  |
  +------> [Inside TcpConnection constructor]
           |
           v
           bufferevent_setcb(bev, ..., static_read_cb, new_conn)
           |
           +------------------------------------------------------+
           | (libevent is now holding new_conn for this specific  |
           |  bufferevent)                                        |
           +------------------------------------------------------+
           |
           | [Client sends data...]
           |
           v
           [libevent calls static_read_cb(..., void* ctx)] <-- ctx IS new_conn
```
---
**9.å®¢æˆ·ç«¯æ”¶å‘**  

send / write: å‘é€æ•°æ®ï¼ŒæŠŠå†…å­˜é‡Œçš„ä¸œè¥¿å¡è¿›å†…æ ¸ç¼“å†²åŒºã€‚
read: æ¥æ”¶æ•°æ®ï¼ŒæŠŠå†…æ ¸ç¼“å†²åŒºé‡Œçš„ä¸œè¥¿è¯»åˆ°ä½ çš„å†…å­˜é‡Œã€‚

---
**10.bufferevent**  

å®ƒå…¶å®æ˜¯ä¸€ä¸ªæœ‰ç¼“å­˜åŒºçš„ç®¡å®¶ï¼Œè§£å†³å¤æ‚I/Oç®¡ç†ï¼Œæ˜¯ä¸ªå¸¦ç¼“å†²çš„äº‹ä»¶
  - å¯¹äºå†™åªéœ€è¦è°ƒç”¨bufferevent_write()å°±ä¸ç”¨ç®¡äº†ï¼Œå¯¹äºè¯»åªè¦è®¾ç½®ç¼–å†™read_cbå³å¯
  - æ— éœ€è‡ªå·±å»poll/selectä¸€ä¸ªsocketçš„çŠ¶æ€ï¼Œåªéœ€è¦è®¾ç½®å›è°ƒå‡½æ•°

---
**11.é—­ç¯æ¨¡å‹**
```bash
           ã€è¯·æ±‚ã€‘
Client ---â†’ NetworkInterface ---â†’ DispatchMsgService ---â†’ UserEventHandler
                                                                  |
                                                                  â†“
Client â†--- NetworkInterface â†--- DispatchMsgService â†--- ç”Ÿæˆ ResponseEvent
           ã€å›åŒ…ã€‘
```
NetworkInterface åªæ”¶åŒ…å›åŒ…ä¸å¤„ç†ä¸šåŠ¡
DispatchMsgService æ´¾å‘eventåˆ°ä¸šåŠ¡ï¼Œç„¶åæ”¶é›†ResponseEventäº¤å›NetworkInterface
UserEventHandler å¤„ç†ä¸šåŠ¡ï¼Œè¿”å›ResponseEventï¼Œä¸åšç½‘ç»œæ“ä½œ

---
**12.æœåŠ¡ç«¯å£°æ˜å‘¨æœŸ**
```bash
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â‘  TCPä¼ è¾“(PBåºåˆ—åŒ–çš„äºŒè¿›åˆ¶åŒ…)
â”‚   å®¢æˆ·ç«¯      â”‚ ---------------------------------------------â–¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

              NetworkInterfaceï¼ˆç½‘ç»œå±‚ - IOçº¿ç¨‹/ä¸»çº¿ç¨‹ï¼‰
              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                    â†“ â‘¡ libevent å›è°ƒæ”¶åˆ°æ•°æ® (bev, read_cb)
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ è§£æ header + body                       â”‚
            â”‚ new MobileCodeReqEv(...)                â”‚ â—€â”€â”€â”€ â‘¢ create_event
            â”‚ ev->set_fd(bufferevent_getfd);   â”‚      (â˜… ä¿å­˜è¿æ¥IDï¼Œè€ŒéæŒ‡é’ˆ)
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚â‘£ dms_->enqueue(std::move(ev))
                               â–¼
              DispatchMsgServiceï¼ˆè°ƒåº¦å±‚ - çº¿ç¨‹æ± ï¼‰
              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                               â”‚â‘¤ è·¨çº¿ç¨‹è°ƒåº¦ process(ev)
                               â–¼

              UserEventHandlerï¼ˆä¸šåŠ¡å±‚ - ä¸šåŠ¡çº¿ç¨‹ï¼‰
              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ æ ¹æ® dispatcher_ æŸ¥æ‰¾å¤„ç†å‡½æ•°                    â”‚
     â”‚ auto rsp = handle_mobile_code_req(req);          â”‚
     â”‚ rsp->set_fd(req->get_fd());               â”‚â”€â”€â”€ â‘¥ â˜… FDæ¥åŠ›ï¼šå°†IDä¼ ç»™å“åº”
     â”‚ delete req;                                      â”‚â”€â”€â”€ â‘¦ é‡Šæ”¾è¯·æ±‚äº‹ä»¶å†…å­˜
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚â‘§ post_response(std::move(rsp))
                               â–¼

              DispatchMsgServiceï¼ˆè°ƒåº¦å±‚ï¼‰
              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                   network_interface->send_response(rsp)
                               â”‚â‘¨ æ”¾å…¥å‘é€é˜Ÿåˆ— (çº¿ç¨‹å®‰å…¨)
                               â–¼

              NetworkInterfaceï¼ˆç½‘ç»œå±‚ - IOçº¿ç¨‹/ä¸»çº¿ç¨‹ï¼‰
              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ std::lock_guard lock(resp_mtx);           â”‚
     â”‚ resp_queue.push(std::move(packet));              â”‚â”€â”€â”€ â‘© ä»…å…¥é˜Ÿï¼Œä¸ç«‹å³å‘é€
     â”‚ (Timerè§¦å‘ flush_send_queue)                     â”‚â”€â”€â”€ â‘ª å¼‚æ­¥å‘é€
     â”‚ æŸ¥æ‰¾ connections_.find(fd)                       â”‚â”€â”€â”€ â˜… æ£€æŸ¥è¿æ¥æ˜¯å¦è¿˜æ´»ç€
     â”‚ bufferevent_write(bev, header+body)              â”‚â”€â”€â”€ â‘« å®‰å…¨å›å‘
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â‘¬ TCPä¼ è¾“(PBåºåˆ—åŒ–çš„äºŒè¿›åˆ¶åŒ…)
â”‚   å®¢æˆ·ç«¯      â”‚ â—€---------------------------------------------
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
ğŸ“Œ é¢è¯•æ—¶çš„è®²è§£é‡ç‚¹ï¼š

æ­¥éª¤ â‘¢ (set_fd)ï¼šå¼ºè°ƒè¿™æ˜¯è§£å†³ Segfault çš„å…³é”®ã€‚æˆ‘ä»¬åˆ‡æ–­äº†ä¸šåŠ¡å±‚å¯¹åº•å±‚ç½‘ç»œå¯¹è±¡ (bufferevent) çš„ç›´æ¥ä¾èµ–ï¼Œåªä¼ é€’ä¸€ä¸ªè½»é‡çº§çš„ IDã€‚  

æ­¥éª¤ â‘¥ (FD æ¥åŠ›)ï¼šå¼ºè°ƒä¸šåŠ¡é€»è¾‘çš„é—­ç¯ã€‚ä¸šåŠ¡å±‚è´Ÿè´£å‘Šè¯‰åº•å±‚â€œè¿™ä¸ªå“åº”æ˜¯å›å¤ç»™å“ªä¸ªè¿æ¥çš„â€ã€‚  

æ­¥éª¤ â‘© ~ â‘ª (å¼‚æ­¥é˜Ÿåˆ—)ï¼šå¼ºè°ƒOne Loop One ThreadåŸåˆ™ã€‚æˆ‘ä»¬ç¦æ­¢ä¸šåŠ¡çº¿ç¨‹ç›´æ¥æ“ä½œ Socketï¼Œè€Œæ˜¯æŠŠæ•°æ®æ‰”å›ç»™ä¸»çº¿ç¨‹ï¼ˆIOçº¿ç¨‹ï¼‰å»å‘ã€‚è¿™ä¸ä»…è§£å†³äº†ç«äº‰é—®é¢˜ï¼Œè¿˜ä¿è¯äº†å‘é€é¡ºåºã€‚  

æ­¥éª¤ â‘ª (find fd)ï¼šå¼ºè°ƒå®¹é”™æ€§ã€‚å¦‚æœå®¢æˆ·ç«¯åœ¨ä¸šåŠ¡å¤„ç†æœŸé—´æ–­å¼€äº†ï¼Œä¸»çº¿ç¨‹æŸ¥ä¸åˆ° fd å°±ä¼šå®‰å…¨ä¸¢å¼ƒï¼Œè€Œä¸ä¼šå› ä¸ºè®¿é—®é‡æŒ‡é’ˆè€Œå´©æºƒã€‚  

---
**13.deleteç›¸å…³**  

å¯¹äºé™æ€ç±»å‹ï¼Œå…¶äº§ç”Ÿçš„å¯¹è±¡æ˜¯å­˜åœ¨æ ˆå†…çš„ï¼Œå¹¶éå †
è€Œnewå‡ºæ¥çš„æ˜¯å †å†…å­˜ï¼Œä»–éœ€è¦é‡Šæ”¾ã€‚è€Œæ ˆå†…çš„å†…å­˜ä¼šè¢«è‡ªåŠ¨æ¸…ç†

---
**14.çº¿ç¨‹çš„joinå’Œdetach**  

joinæ˜¯åŠ å…¥æ±‡åˆï¼Œçº¿ç¨‹ä¼šé˜»å¡ç­‰å¾…
detachæ˜¯åˆ†ç¦»ï¼Œéé˜»å¡ï¼Œè·‘å„çš„

---
**15.connectionpoolå†…çš„è®¾è®¡**  

produceConnectionçš„pushå¹¶æœªä¸Šé”ï¼Œæ˜¯å› ä¸ºgetConnectionéœ€è¦é”ï¼Œè€Œå†åŠ ä¸€å±‚ä¼šæ­»é”
å¦‚æœä¸åŠ ï¼Œè¿è¡Œæ—¶ï¼ˆgetConnectionï¼‰ï¼šé å¤–å±‚çš„é”æ¥ä¿è¯å®‰å…¨ï¼ˆé˜²æ­¢æ­»é”ï¼‰å¯åŠ¨æ—¶ï¼ˆinitï¼‰ï¼šé â€œå•çº¿ç¨‹ç¯å¢ƒâ€æ¥ä¿è¯å®‰å…¨ï¼ˆå› ä¸ºé‚£æ—¶å€™è¿˜æ²¡äººè·Ÿå®ƒæŠ¢ï¼‰ï¼Œä¸ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜
è¿™è¢«ç§°ä¸ºæ— â€œé” helper å‡½æ•° + æœ‰é” public æ¥å£â€æ¨¡å¼


---
**16.ä¸€äº›å›ç­”ç­”æ¡ˆ**  

1.â€œå°è£…æ˜¯ä¸ºäº†éµå¾ª RAII åŸåˆ™ï¼Œåˆ©ç”¨ C++ å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ¥ç®¡ç† C è¯­è¨€çš„åŸå§‹èµ„æºï¼Œé˜²æ­¢å¿˜è®°è°ƒç”¨ mysql_close å¯¼è‡´èµ„æºæ³„æ¼ã€‚

å…³äº freeResultï¼Œä¸ä»…ä»…æ˜¯ä¸ºäº†ä»£ç å¤ç”¨ï¼Œæ›´é‡è¦çš„æ˜¯ä¸ºäº†é˜²æ­¢å†…å­˜æ³„æ¼ã€‚å› ä¸º mysql_store_result ä¼šåœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œå¦‚æœæˆ‘åœ¨å¤ç”¨è¿æ¥è¿›è¡Œä¸‹ä¸€æ¬¡æŸ¥è¯¢å‰ä¸é‡Šæ”¾ä¸Šä¸€æ¬¡çš„ç»“æœï¼Œæ—§çš„å†…å­˜åœ°å€å°±ä¼šä¸¢å¤±ï¼Œå¯¼è‡´ä¸¥é‡çš„å†…å­˜æ³„æ¼ã€‚å°†å…¶ç‹¬ç«‹å°è£…èƒ½ä¿è¯åœ¨â€˜ææ„æ—¶â€™å’Œâ€˜æ–°æŸ¥è¯¢å‰â€™éƒ½èƒ½å®‰å…¨åœ°æ¸…ç†èµ„æºã€‚â€

2.â€œå…³äºè‡ªåŠ¨å›æ”¶ï¼Œæˆ‘ç¡®å®ä½¿ç”¨äº† shared_ptr çš„è‡ªå®šä¹‰åˆ é™¤å™¨ã€‚å½“ä¸šåŠ¡å±‚å¼•ç”¨è®¡æ•°å½’é›¶æ—¶ï¼ŒLambda è¡¨è¾¾å¼ä¼šæ‹¦æˆªåˆ é™¤æ“ä½œï¼Œå°†è¿æ¥é‡æ–° push å›é˜Ÿåˆ—ï¼Œå®ç°å¤ç”¨ã€‚

å…³äºçº¿ç¨‹å®‰å…¨ï¼šå› ä¸ºè¿æ¥æ± æ˜¯å¤šçº¿ç¨‹å…±äº«çš„ï¼Œæˆ‘åœ¨æ“ä½œé˜Ÿåˆ—ï¼ˆå–è¿æ¥/è¿˜è¿æ¥ï¼‰æ—¶ä½¿ç”¨äº† std::mutexï¼ˆäº’æ–¥é”ï¼‰ æ¥ä¿è¯åŸå­æ€§ã€‚åŒæ—¶ï¼Œæˆ‘ä½¿ç”¨äº† std::condition_variableï¼ˆæ¡ä»¶å˜é‡ï¼‰ æ¥å®ç°ç”Ÿäº§-æ¶ˆè´¹æ¨¡å‹ï¼šå½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œæ¶ˆè´¹è€…ä¼šé˜»å¡ç­‰å¾…ï¼›å½“æœ‰è¿æ¥å½’è¿˜æ—¶ï¼Œä¼šè‡ªåŠ¨å”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼Œé¿å…äº†è½®è¯¢é€ æˆçš„ CPU æµªè´¹ã€‚â€

3.â€œDAO ç¡®å®æ˜¯ä¸ºäº†è§£è€¦ã€‚

å…³äºä¸ºä»€ä¹ˆç”¨ INSERT ... ON DUPLICATE KEY UPDATEï¼Œé™¤äº†ä»£ç ç®€æ´å¤–ï¼Œä¸»è¦æ˜¯ä¸ºäº†è§£å†³å¹¶å‘åœºæ™¯ä¸‹çš„ç«æ€æ¡ä»¶ (Race Condition)ã€‚

å¦‚æœæˆ‘ç”¨â€˜å…ˆæŸ¥è¯¢(Select)åæ’å…¥(Insert)â€™çš„ä¸¤æ­¥é€»è¾‘ï¼š åœ¨é«˜å¹¶å‘ä¸‹ï¼Œå¯èƒ½æœ‰ä¸¤ä¸ªçº¿ç¨‹ A å’Œ B åŒæ—¶æŸ¥åˆ°ç”¨æˆ·ä¸å­˜åœ¨ã€‚ç„¶å A æ’å…¥æˆåŠŸäº†ï¼ŒB å†å»æ’å…¥æ—¶å°±ä¼šæŠ¥**â€˜ä¸»é”®å†²çªâ€™**é”™è¯¯ã€‚ ä½¿ç”¨è¿™æ¡åŸå­æ€§çš„ SQL è¯­å¥ï¼Œå°†æ£€æŸ¥å’Œæ’å…¥åˆå¹¶ç”±æ•°æ®åº“åº•å±‚åŠ é”å¤„ç†ï¼Œå½»åº•é¿å…äº†è¿™ç§å¹¶å‘å†²çªï¼Œä¿è¯äº†æ“ä½œçš„åŸå­æ€§ã€‚â€

4.åœºæ™¯ï¼š ä½ åœ¨ UserEventHandler é‡Œè°ƒç”¨äº† auto conn = pool->getConnection();ã€‚ å‡è®¾åœ¨è¿™ä¸ªå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼ŒæŠ›å‡ºäº†ä¸€ä¸ªå¼‚å¸¸ï¼ˆæ¯”å¦‚ std::stoi è½¬æ¢å¤±è´¥ï¼‰ï¼Œå¯¼è‡´å‡½æ•°æå‰é€€å‡ºï¼Œæ²¡æœ‰æ‰§è¡Œåˆ°æœ€åçš„ returnã€‚ è¯·é—®ï¼š è¿™ä¸ªè¿æ¥ä¼šæ³„æ¼å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿè¿™ä½“ç°äº† C++ çš„ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

æµç¨‹ï¼šæŠ›å‡ºå¼‚å¸¸ -> è§¦å‘æ ˆå±•å¼€ -> conn æ™ºèƒ½æŒ‡é’ˆææ„ -> è§¦å‘è‡ªå®šä¹‰åˆ é™¤å™¨ Lambda -> æ‰§è¡Œ push() -> è¿æ¥å›åˆ°é˜Ÿåˆ—ã€‚
ç»“è®ºï¼šè¿™å°±æ˜¯ C++ RAII æœ€å¼ºå¤§çš„åœ°æ–¹â€”â€”åªè¦å¯¹è±¡åˆ›å»ºæˆåŠŸï¼Œæ— è®ºä½ æ€ä¹ˆæ­»ï¼ˆreturn è¿˜æ˜¯ exceptionï¼‰ï¼Œæ”¶å°¸å·¥ä½œï¼ˆææ„ï¼‰ä¸€å®šä¼šæ‰§è¡Œã€‚ æ‰€ä»¥ä½ çš„è¿æ¥æ± æ˜¯â€œå¼‚å¸¸å®‰å…¨â€çš„

---
**17.å¿«æ·æŸ¥æ‰¾**
```bash
grep -rn "xx" .
```
åœ¨å½“å‰ç›®å½•é€’å½’æŸ¥æ‰¾å¹¶æ˜¾ç¤ºè¡Œæ•°çš„æœç´¢xx

---
**18.æˆ‘ä¸€ç‚¹å¤´ç»ªéƒ½æ²¡æœ‰çš„é—®é¢˜**  

1.ä½ æåˆ°ç”¨äº† CAS (Compare And Swap) æ¥è§£å†³å¹¶å‘å¼€é”ã€‚ å¦‚æœçº¿ç¨‹ A æŸ¥åˆ°çŠ¶æ€æ˜¯ 0ã€‚ è¿™æ—¶å€™çº¿ç¨‹ B æŠŠçŠ¶æ€æ”¹æˆ 1ï¼ˆå¼€é”ï¼‰ï¼Œç„¶ååˆè¿…é€Ÿæ”¹å› 0ï¼ˆè¿˜è½¦ï¼‰ã€‚ è½®åˆ°çº¿ç¨‹ A æ‰§è¡Œ Update æ—¶ï¼Œå®ƒå‘ç°çŠ¶æ€è¿˜æ˜¯ 0ï¼Œäºæ˜¯å¼€é”æˆåŠŸäº†ã€‚ åœ¨è¿™ä¸ªå…±äº«å•è½¦çš„åœºæ™¯ä¸‹ï¼Œè¿™ç§ ABA é—®é¢˜ä¼šæœ‰å‰¯ä½œç”¨å—ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
ç­”ï¼š
  è¿™ä¸ªåœºæ™¯ABAå¹¶æ²¡æœ‰å‰¯ä½œç”¨ï¼ŒABäº’ç›¸æ²¡æœ‰å½±å“ï¼Œä½†æ˜¯åœ¨çŠ¶æ€å˜åŒ–éœ€è¦è®°å½•çš„åœºæ™¯ABAé—®é¢˜å°±ä¼šå‡ºé”™ï¼ˆæ¯”å¦‚é¦–å•å…å•çš„ABAï¼‰ï¼Œå¦‚æœæƒ³è§£å†³çš„è¯å°±æ˜¯åŠ å…¥ç‰ˆæœ¬å·ï¼Œæ¯æ¬¡updateè®¡å…¥ç‰ˆæœ¬å·çš„æ›´æ”¹ï¼Œç‰ˆæœ¬å·å˜äº†æ›´æ–°å°±å¤±æ•ˆ

---
**19.ä¸€æ¬¡æ›´æ–°çš„ç†ç”±**  

é€šè¿‡æ¨¡æ‹Ÿçš„é—®é¢˜ï¼Œæˆ‘å‘ç°æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘æ²¡æ³•è§£å†³â€œå¦‚æœæ‰£äº†ç”¨æˆ·çš„é’±ï¼ˆå‡è®¾ä½ æœ‰æ‰£è´¹é€»è¾‘ï¼‰ï¼Œä½†æ˜¯å¼€é”å¤±è´¥äº†â€çš„é—®é¢˜

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å†³å®šå¯¹å‡½æ•°è¿›è¡Œé‡è½½ã€‚å› ä¸ºè¿™æ˜¯ä¸¤ä¸ªè¡¨ï¼Œå½¼æ­¤é—´æ²¡æœ‰è¿æ¥ï¼Œè‡ªç„¶æ— æ³•æ‰§è¡Œè·¨è¡¨ä»»åŠ¡ï¼Œé‚£è§£å†³æ–¹æ¡ˆè‡ªç„¶å°±æ˜¯å»ºç«‹è¿æ¥ï¼Œåªéœ€è¦æˆ‘ä»¬é‡è½½ä¸¤ä¸ªDAOå‡½æ•°çš„æ¥å£ï¼ŒåŠ å…¥ä¸€ä¸ªå¼€å¯äº‹åŠ¡çš„è¿æ¥çš„å‚æ•°å¹¶åˆ©ç”¨ï¼Œæœ€åç”±ä¸šåŠ¡å±‚ç»Ÿä¸€conn->commit()å³å¯
ä¹Ÿå°±æ˜¯ä»è¿æ¥æ± ç”³è¯·å”¯ä¸€çš„ä¸€ä¸ªæ•°æ®åº“è¿æ¥ (conn)ã€‚

ä¸€å£°ä»¤ä¸‹ï¼šconn->transaction() å¼€å¯äº‹åŠ¡ï¼ˆæ­¤æ—¶æ•°æ®åº“è¿›å…¥â€œå½•åƒæ¨¡å¼â€ï¼‰ã€‚
ååŒä½œæˆ˜ï¼š
æŒ‡æŒ¥ UserDao æŸ¥äººï¼ˆå¿…é¡»ç”¨åˆšæ‰é‚£ä¸ª connï¼‰ã€‚
æŒ‡æŒ¥ BikeDao æŸ¥è½¦ï¼ˆå¿…é¡»ç”¨åˆšæ‰é‚£ä¸ª connï¼‰ã€‚
æŒ‡æŒ¥ BikeDao æ”¹çŠ¶æ€ï¼ˆå¿…é¡»ç”¨åˆšæ‰é‚£ä¸ª connï¼‰ã€‚

å¯¹äºä»£ç ä¸­çš„å‚æ•°
å¦‚æœä¼ è¿›æ¥çš„æ˜¯ç©ºï¼Œå°±å»æ± é‡Œæ‹¿ï¼›å¦‚æœä¸æ˜¯ç©ºï¼Œå°±ç”¨ä¼ è¿›æ¥çš„ã€‚
æ³¨æ„ï¼šå¦‚æœå»æ± é‡Œæ‹¿ï¼Œéœ€è¦ç”¨ shared_ptr è‡ªåŠ¨å›æ”¶ï¼›å¦‚æœæ˜¯ä¼ è¿›æ¥çš„ï¼Œæˆ‘ä»¬ä¸è´Ÿè´£å›æ”¶ï¼ˆä¸šåŠ¡å±‚è´Ÿè´£ï¼‰

---
**20.å…³äºæ‹·è´**  

MysqlConn* a = b;æ˜¯æµ…æ‹·è´ï¼Œåªæ˜¯ä¸€ä¸ªaåªæ˜¯å¥æŸ„ï¼Œå€Ÿç”¨bï¼Œaä¸æ˜¯ä¸€ä¸ªæ–°å¯¹è±¡
åªæœ‰éæŒ‡é’ˆå¯¹è±¡çš„=æ‰å­˜åœ¨æ‹·è´æ„é€ çš„é—®é¢˜

---
**21.mysqlAPIè¿”å›å€¼**  

MySQL çš„ C API å‡½æ•°ï¼ˆå¦‚ mysql_autocommit, mysql_commit, mysql_rollbackï¼‰éµå¾ªçš„æ˜¯ C è¯­è¨€çš„è€è§„çŸ©ï¼š
è¿”å› 0ï¼šè¡¨ç¤ºæˆåŠŸ (Success)ã€‚
è¿”å› é0ï¼šè¡¨ç¤ºå¤±è´¥ (Error)ã€‚

è¿™å’Œæˆ‘ä»¬å¹³æ—¶çš„è¿”å›é€»è¾‘ä¸å¤ªä¸€æ ·ï¼Œæ‰€ä»¥è¦æ³¨æ„ï¼Œæˆ‘ä»¬ç¬¬ä¸€æ¬¡ç”¨æ‰€ä»¥é”™äº†ä¸€æ¬¡

---
**22.redisä¸mysqlç­–ç•¥åŠåŸå› **  

1. ä¸ºä»€ä¹ˆ Redis å¯ä»¥ç”¨ Thread Localï¼Ÿ
èµ„æºè½»é‡çº§ï¼šRedis æ˜¯åŸºäºå†…å­˜çš„ï¼Œè¿æ¥å¤„ç†éå¸¸å¿«ã€‚ä¸€ä¸ª Redis å®ä¾‹ç»´æŒå‡ åƒä¸ªç©ºé—²è¿æ¥æ¯«ä¸è´¹åŠ›ã€‚

æ“ä½œåŸå­ä¸”æå¿«ï¼šRedis çš„å‘½ä»¤é€šå¸¸æ˜¯å¾®ç§’çº§ï¼ˆusï¼‰ã€‚

çº¿ç¨‹æ•°å›ºå®šï¼šä½ çš„ ThreadPool åªæœ‰ 4-8 ä¸ªçº¿ç¨‹ã€‚è¿™æ„å‘³ç€æ•´ä¸ªè¿›ç¨‹åªä¼šæœ‰ 4-8 ä¸ª Redis è¿æ¥ã€‚è¿™ç‚¹å¼€é”€å¯¹ Redis æ¥è¯´æ˜¯ä¹ç‰›ä¸€æ¯›ã€‚

æ— äº‹åŠ¡ä¸Šä¸‹æ–‡ï¼šåœ¨ä½ çš„ç”¨æ³•é‡Œï¼ŒRedis åªæ˜¯å­˜å– Tokenï¼Œä¸éœ€è¦åƒ MySQL é‚£æ ·å¼€å¯ä¸€ä¸ªé•¿äº‹åŠ¡å ç”¨è¿æ¥å¾ˆä¹…ã€‚

ç»“è®ºï¼šç»™æ¯ä¸ªçº¿ç¨‹å‘ä¸€ä¸ªâ€œç§äºº Redis è¿æ¥â€æ˜¯åˆ’ç®—çš„ï¼Œæ˜¯ç”¨æå°çš„ç©ºé—´æˆæœ¬æ¢å–äº†æ— é”çš„é«˜æ€§èƒ½ã€‚

2. ä¸ºä»€ä¹ˆ MySQL å¿…é¡»ç”¨è¿æ¥æ±  (Singleton Pool)ï¼Ÿ
A. è¿æ¥æå…¶æ˜‚è´µ (Heavyweight)
MySQL æœåŠ¡ç«¯ï¼šæ¯ä¸€ä¸ª TCP è¿æ¥ï¼ŒMySQL æœåŠ¡ç«¯éƒ½è¦åˆ†é…çº¿ç¨‹æ ˆã€è¿æ¥ç¼“å†²ã€æ’åºç¼“å†²ç­‰å†…å­˜ã€‚

è¿æ¥æ•°é™åˆ¶ï¼šMySQL é»˜è®¤çš„ max_connections é€šå¸¸åªæœ‰ 151ï¼ˆç”Ÿäº§ç¯å¢ƒå¯èƒ½è°ƒåˆ° 1000-2000ï¼‰ã€‚

å¦‚æœç”¨ Thread Localï¼š

ç°åœ¨ä½ åªæœ‰ 4 ä¸ªçº¿ç¨‹ï¼Œæ²¡é—®é¢˜ï¼ˆ4 ä¸ªè¿æ¥ï¼‰ã€‚

ä½†å¦‚æœä»¥åä¸ºäº†æé«˜å¹¶å‘ï¼Œä½ æŠŠçº¿ç¨‹æ± å¼€åˆ°äº† 500 ä¸ªçº¿ç¨‹ï¼ˆä¸ºäº†æ©ç›– I/O å»¶è¿Ÿï¼‰ã€‚

é‚£ä¹ˆä½ å°±éœ€è¦å»ºç«‹ 500 ä¸ª MySQL è¿æ¥ã€‚MySQL æœåŠ¡ç«¯å¯èƒ½ç›´æ¥æŠ¥è­¦ç”šè‡³æŒ‚æ‰ã€‚

B. å¤ç”¨ç‡ä¸å‰Šå³°å¡«è°· (Multiplexing)
åœºæ™¯ï¼šçº¿ç¨‹ A æ­£åœ¨å¤„ç†ä¸€ä¸ªä¸éœ€è¦æŸ¥æ•°æ®åº“çš„è¯·æ±‚ï¼ˆæ¯”å¦‚åªæŸ¥ Redisï¼‰ï¼Œçº¿ç¨‹ B æ­£åœ¨å¤„ç†ä¸€ä¸ªå¤æ‚çš„ SQLã€‚

Thread Localï¼šçº¿ç¨‹ A çš„ MySQL è¿æ¥åœ¨ç¡å¤§è§‰ï¼ˆé—²ç½®æµªè´¹ï¼‰ï¼Œè€Œçº¿ç¨‹ B å¯èƒ½å› ä¸ºæ²¡æœ‰è¿æ¥å¯ç”¨è€Œå¹²ç€æ€¥ï¼ˆå¦‚æœæ²¡é™åˆ¶çš„è¯ï¼‰ã€‚

è¿æ¥æ± ï¼šè¿æ¥æ˜¯å…¬å…±èµ„æºã€‚è°è¦ç”¨è°æ‹¿ï¼Œç”¨å®Œèµ¶ç´§è¿˜å›æ¥ç»™åˆ«äººç”¨ã€‚

æ ¸å¿ƒä»·å€¼ï¼šç”¨å°‘é‡çš„è¿æ¥ï¼ˆæ¯”å¦‚ 10 ä¸ªï¼‰æ”¯æ’‘å¤§é‡çš„å¹¶å‘çº¿ç¨‹ï¼ˆæ¯”å¦‚ 100 ä¸ªï¼‰ã€‚

C. é”çš„å¼€é”€ vs I/O å¼€é”€
Redisï¼šæ“ä½œè€—æ—¶ 0.1msã€‚å¦‚æœåŠ é”ï¼ˆè€—æ—¶ 0.01msï¼‰ï¼Œé”çš„å¼€é”€å äº† 10%ï¼Œå¾ˆè‚‰ç–¼ã€‚æ‰€ä»¥æˆ‘ä»¬è¦å»é”ã€‚

MySQLï¼šæ“ä½œè€—æ—¶ 10ms ~ 500msã€‚å¦‚æœåŠ é”å–è¿æ¥ï¼ˆè€—æ—¶ 0.01msï¼‰ï¼Œå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚

ä¸ºäº†çœè¿™ç‚¹é”çš„æ—¶é—´ï¼Œæ”¾å¼ƒè¿æ¥æ± çš„ä¿æŠ¤æœºåˆ¶ï¼Œæ˜¯å¾—ä¸å¿å¤±çš„ã€‚

---
**23.åœ¨å½“å‰çº¿ç¨‹ä½¿ç”¨redis_tool**  

ä½¿ç”¨static thread_local
åªæœ‰éªŒè¯ç å¯¹æ¯”æˆåŠŸæˆ‘ä»¬æ‰ç»™token

---
**24.æˆ‘æ˜¯å‚»é€¼** 

ğŸ’€ é™·é˜±ä¸€ï¼šString çš„â€œç©ºæŒ‡é’ˆæ­»åˆ‘â€
æŠ¥é”™ç‰¹å¾ï¼š terminate called after throwing an instance of 'std::logic_error' what(): basic_string::_M_construct null not valid

æ ¸å¿ƒåŸç†ï¼š C++ çš„ std::string ä¸åƒ Java æˆ– Go çš„ String é‚£æ ·å®½å®¹ã€‚ç»å¯¹ä¸èƒ½ç”¨ NULL (0, nullptr) å»æ„é€ æˆ–èµ‹å€¼ç»™ std::stringï¼Œå¦åˆ™ç›´æ¥å´©æºƒã€‚

åˆå§‹åŒ–åˆ—è¡¨ï¼šä»€ä¹ˆéƒ½ä¸å†™ï¼ˆé»˜è®¤å°±æ˜¯ç©ºä¸²ï¼‰ï¼Œæˆ–è€…å†™ ""ã€‚
```C++
MyClass() : ip_() {} // æˆ–è€… ip_("")
```
C æ¥å£å°è£…ï¼šå¿…é¡»é˜²å¾¡æ€§åˆ¤ç©ºã€‚
```C++
const char* val = c_library_get_value("key");
string s = (val != nullptr) ? val : ""; // å®‰å…¨
```


â›“ï¸ é™·é˜±äºŒï¼šProtobuf ä¿®æ”¹çš„â€œå…¨é“¾è·¯é—å¿˜â€
ç°è±¡æè¿°ï¼š .proto æ–‡ä»¶æ”¹äº†ï¼Œmake ä¹Ÿç¼–è¯‘è¿‡äº†ï¼Œå®¢æˆ·ç«¯ä¹Ÿæ²¡é—®é¢˜ï¼Œä½†æœåŠ¡ç«¯ä¸šåŠ¡å±‚æ­»æ´»è¯»ä¸åˆ°æ–°åŠ çš„å­—æ®µï¼ˆæ¯”å¦‚ Token ä¸ºç©ºï¼‰ã€‚

æ ¸å¿ƒåŸç†ï¼š æˆ‘ä»¬çš„æ¶æ„æ˜¯ åˆ†å±‚è§£è€¦ çš„ã€‚Protobuf åªæ˜¯æ•°æ®è½½ä½“ï¼Œæ•°æ®ä»ç½‘å¡æµå‘ä¸šåŠ¡é€»è¾‘ï¼Œä¸­é—´ç»è¿‡äº†å¤šæ¬¡**â€œæ¬è¿â€**ã€‚æ”¹äº†æºå¤´ï¼ˆProtoï¼‰ï¼Œå¦‚æœä¸æ”¹ä¸­é—´çš„æ¬è¿å·¥ï¼Œæ•°æ®å°±ä¼šåœ¨ä¸­é—´ä¸¢æ‰ã€‚

ğŸ› ï¸ åè®®ä¿®æ”¹æ ‡å‡†æ£€æŸ¥æ¸…å• (Checklist)ï¼š

å½“ä½ ç»™ .proto å¢åŠ äº†ä¸€ä¸ªå­—æ®µï¼ˆä¾‹å¦‚ tokenï¼‰æ—¶ï¼Œå¿…é¡»æŒ‰é¡ºåºæ£€æŸ¥ä»¥ä¸‹ 4 ä¸ªåœ°æ–¹ï¼š

- æºå¤´ï¼šProto å®šä¹‰
  ä¿®æ”¹ xxx.protoï¼Œæ‰§è¡Œ make é‡æ–°ç”Ÿæˆ pb.h/ccã€‚

- æ¬è¿å·¥ Aï¼šäº‹ä»¶åŒ…è£…ç±»å®šä¹‰ (.h) 
  ä¿®æ”¹ UnlockReq ç±»ï¼Œæ„é€ å‡½æ•°å¢åŠ å‚æ•° const string& tokenã€‚
  å¢åŠ  getter æ–¹æ³• getToken()ã€‚

- æ¬è¿å·¥ Bï¼šäº‹ä»¶åŒ…è£…ç±»å®ç° (.cpp)
  æœ€å®¹æ˜“å¿˜ï¼ ä¿®æ”¹æ„é€ å‡½æ•°çš„å®ç°ï¼ŒæŠŠå‚æ•°å­˜è¿› msg_.set_token(token)ã€‚å¦‚æœä¸åŠ è¿™è¡Œï¼Œå‚æ•°ä¼ è¿›æ¥äº†ä¹Ÿæ²¡ç”¨ã€‚

- æ¬è¿å·¥ Cï¼šå·¥å‚ç”Ÿäº§çº¿ (DispatchMsgService)
  æœ€å®¹æ˜“å¿˜ï¼ åœ¨ create_event çš„ case é‡Œï¼Œä» proto å¯¹è±¡å–å‡º token()ï¼Œä¼ ç»™ UnlockReq çš„æ–°æ„é€ å‡½æ•°ã€‚

å£è¯€ï¼š
â€œæ”¹äº† Proto åˆ«æ€¥è·‘ï¼Œå·¥å‚ã€æ„é€ ã€Getter ä¸€ä¸ªä¸èƒ½å°‘ã€‚â€

---
**25.redisä½¿ç”¨è¿æ¥æ± ä¼šå–§å®¾å¤ºä¸»çš„çœŸç›¸** 

æ ¸å¿ƒå…³é”®è¯ï¼šé”ç«äº‰ (Lock Contention)ã€‚

Redis çš„æ“ä½œæå¿«ï¼ˆå¾®ç§’çº§ï¼‰ã€‚å¦‚æœç”¨è¿æ¥æ± ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½è¦å»æŠ¢é‚£ä¸€æŠŠ mutex é”ã€‚åœ¨é«˜å¹¶å‘ä¸‹ï¼Œçº¿ç¨‹åœ¨é”ä¸Šæ’é˜Ÿçš„æ—¶é—´ï¼Œå¯èƒ½æ¯” Redis æ‰§è¡Œå‘½ä»¤çš„æ—¶é—´è¿˜é•¿ã€‚è¿™æ‰æ˜¯â€œå–§å®¾å¤ºä¸»â€çš„çœŸç›¸ã€‚

---
**26.ä¸ä½¿ç”¨å¼‚æ­¥æ—¥å¿—çš„åŸå› **  

è™½ç„¶ç¡®å®èƒ½è§£å†³å†™ç£ç›˜é˜»å¡ä¸šåŠ¡çº¿ç¨‹ï¼Œä½†æ˜¯ç»è¿‡åˆ†ææˆ‘å‘ç°æˆ‘çš„å¹³é™ä¸»è¦åœ¨äºæ—¥å¿—é‡è¿‡å¤§ï¼Œä¼šåˆ·å±ï¼Œå³ä½¿ç”¨äº†å¼‚æ­¥æ—¥å¿—ï¼Œä¹Ÿä¼šå ç”¨å¤§é‡cpuå»åšå­—ç¬¦ä¸²æ ¼å¼åŒ–å’Œå†…å­˜æ‹·è´
å¯¹äºè¿™ä¸ªé—®é¢˜æˆ‘é€‰æ‹©äº†ä»æºå¤´æ²»ç†ï¼Œä½¿ç”¨æ—¥å¿—åˆ†çº§ï¼Œç›´æ¥æŠŠæ— å…³æ—¥å¿—è¿‡æ»¤æ‰ï¼Œä¸è®©å®ƒä»¬äº§ç”Ÿä»»ä½• CPU å’Œ I/O æ¶ˆè€—ã€‚è¿™æ¯”å¼‚æ­¥å†™åƒåœ¾æ—¥å¿—æ›´é«˜æ•ˆã€‚

---
**27.HTTPè¯·æ±‚**
- è¯·æ±‚è¡Œ åŒ…å«æ–¹æ³•(GET/POST) + URL + åè®®ç‰ˆæœ¬
  - GET /index.html HTTP/1.1 æ ¹æ®ç©ºæ ¼åˆ’åˆ†
- è¯·æ±‚å¤´ æ˜¯é”®å€¼å¯¹ï¼Œå±æ€§å: å±æ€§å€¼
  - æ ¹æ®å†’å·åˆ’åˆ†
- ç©ºè¡Œ è¿™ä¸ªæ˜¯ç”¨æ¥åˆ’åˆ†è¯·æ±‚ä½“å’Œè¯·æ±‚å¤´çš„
- è¯·æ±‚ä½“ å‘é€çš„å®é™…å†…å®¹

---
**28.httpcontextå†…éƒ¨ç´¢å¼•æ³•**
```c++
char* line_end_ptr = std::search(text_begin + m_idx_, text_end, "\r\n", "\r\n" + 2);
```
std::search(æœç´¢èµ·ç‚¹, æœç´¢ç»ˆç‚¹, ç›®æ ‡èµ·ç‚¹, ç›®æ ‡ç»ˆç‚¹)
æ²¡æ‰¾åˆ°å°±æ˜¯line_end_ptr == text_end
è¿™ä¸ªæ‰¾åˆ°çš„ä½ç½®æ˜¯\rçš„ä½ç½®ï¼Œæ‰€ä»¥m_idx_çš„æ›´æ–°è¦è·³è¿‡\r\nå°±æ˜¯+2

---
**29.networkinterfaceç²˜åŒ…å¤„ç†**
æˆ‘ä»¬æ˜¯è¿™æ ·å†™çš„é€»è¾‘
```c++
evbuffer_drain(input, processed_len);
context->reset();
```
è§£æå®Œç¬¬ä¸€ä¸ªåŒ…åï¼Œåˆ æ‰ç¬¬ä¸€ä¸ªåŒ…ç„¶åç´¢å¼•å½’é›¶ï¼Œå°±æ˜¯è¾¹åƒè¾¹æ‹‰

---
**30.content-lengthå’Œé•¿è¿æ¥**
å¦‚æœå¼„é”™äº†Content-Lengthå°±ä¼šåˆæ®‹ç•™ï¼Œè€Œæ®‹ç•™ä¼šå½“ä½œä¸‹ä¸€æ¬¡è¯·æ±‚å¤„ç†ï¼Œä½†æ˜¯ä¸åˆæ³•æ‰€ä»¥è¿”å›BAD_REQUESTï¼Œå¦‚æœå¤„ç†é”™è¯¯æ˜¯å…³é—­è¿æ¥çš„è¯ï¼Œé•¿è¿æ¥æœºåˆ¶ä¼šè¢«ç ´åï¼Œåç»­çš„è¯·æ±‚å‘å¸ƒè¿‡äº†ï¼Œæ›´ä¸¥é‡çš„æ°å¥½bodyå¾ˆé•¿å‡‘æˆäº†ä¸€ä¸ªHTTPæ ¼å¼å°±ä¼šå‘ç”ŸHTTPèµ°ç§

---
**31.å…³äºç±»å†…çš„getå‡½æ•°åŠ ä¸åŠ const**
```c++
HttpContext* get_context()  { return &context_; }
```
å¹¶ä¸”æˆå‘˜æ˜¯æ™®é€šå¯¹è±¡ï¼Œä¸æ˜¯æŒ‡é’ˆï¼Œè¿™æ ·å¯ä»¥çœå»æ‰‹åŠ¨ç®¡ç†ï¼Œè€Œè¿”å›å¼•ç”¨ä¸”ä¸èƒ½åŠ constï¼Œé¦–å…ˆæ˜¯è¿™ä¿©å†²çªï¼Œå› ä¸ºè¿”å›&å°±å¿…ç„¶è¦ä¿®æ”¹çš„ï¼Œæ‰€ä»¥ä¸èƒ½constï¼Œè€Œä¸”è¿”å›å¼•ç”¨ä¹Ÿæ˜¯ä¸“tcpconnectionä¸“ç”¨